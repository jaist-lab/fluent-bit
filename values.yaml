# values.yaml
fluent-bit:
  image:
    repository: fluent/fluent-bit
    tag: 3.1.9
  
  # DaemonSet として全ノードにデプロイ
  kind: DaemonSet
  
  # リソース制限
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi
  
  # ログ収集設定
  config:
    service: |
      [SERVICE]
          Daemon Off
          Flush 1
          Log_Level info
          Parsers_File parsers.conf
          Parsers_File custom_parsers.conf
          HTTP_Server On
          HTTP_Listen 0.0.0.0
          HTTP_Port 2020
          Health_Check On
    
    inputs: |
      [INPUT]
          Name tail
          Path /var/log/containers/*.log
          multiline.parser docker, cri
          Tag kube.*
          Mem_Buf_Limit 5MB
          Skip_Long_Lines On
    
    filters: |
      [FILTER]
          Name kubernetes
          Match kube.*
          Kube_URL https://kubernetes.default.svc:443
          Kube_CA_File /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          Kube_Token_File /var/run/secrets/kubernetes.io/serviceaccount/token
          Kube_Tag_Prefix kube.var.log.containers.
          Merge_Log On
          Keep_Log Off
          K8S-Logging.Parser On
          K8S-Logging.Exclude On
      
      # ログレベルでのフィルタリング（オプション）
      [FILTER]
          Name grep
          Match kube.*
          Exclude log ^\s*$
    
    outputs: |
      [OUTPUT]
          Name forward
          Match *
          Host 172.16.100.200
          Port 24224
          # 接続タイムアウト設定
          Require_ack_response true
          # リトライ設定
          Retry_Limit 5
          # バッファ設定
          storage.total_limit_size 10M
      
      # デバッグ用のstdout出力（オプション、本番環境では削除推奨）
      [OUTPUT]
          Name stdout
          Match *
          Format json_lines
  
  # ServiceAccount の設定
  serviceAccount:
    create: true
    name: fluent-bit
  
  # RBAC の設定
  rbac:
    create: true
  
  # ボリュームマウント
  volumeMounts:
    - name: varlog
      mountPath: /var/log
    - name: varlibdockercontainers
      mountPath: /var/lib/docker/containers
      readOnly: true
  
  volumes:
    - name: varlog
      hostPath:
        path: /var/log
    - name: varlibdockercontainers
      hostPath:
        path: /var/lib/docker/containers
  
  # tolerations の設定（全ノードにデプロイする場合）
  tolerations:
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule
    - key: node-role.kubernetes.io/master
      operator: Exists
      effect: NoSchedule
